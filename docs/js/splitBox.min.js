"use strict";!function(t){t.module("splitbox",[]).directive("splitBox",["$compile","splitBox::utils",function(t,e){return{restrict:"A",link:function(i,r,n){var o={exportName:"splitBox",boxs:[],boxTemplate:'<div class="split-box"></div>',barTemplate:'<div class="split-bar"></div>',direction:"x",barWidth:10,minSize:5,isFlat:!0,animateClass:""};angular.extend(o,i[n.splitBox]),r[0].style.position&&"static"!==r[0].style.position||r.css({position:"relative"});var s=e.transformToNextedBoxs(o.boxs,o.direction),a=e.getItems(s);s.$boxs=e.boxHTML(a.boxs,o),s.$bars=e.barHTML(a.bars.length,o),s.config=o,s.rootElement=r,t(s.$boxs)(i),t(s.$bars)(i),e.render(s),e.relateBoxs(a.boxs,s),e.relateBars(a.bars,s),r.append(s.$boxs),r.append(s.$bars),s.addDom=function(e,n){t(e)(i),r[n?"prepend":"append"](e)},n.splitBoxExports&&(i[n.splitBoxExports]=s),console.log(s)}}}]).directive("splitBar",["$rootScope","$window",function(t,e){var i,r="<div></div>",n={web:{down:"mousedown",up:"mouseup",move:"mousemove"},mobile:{down:"touchstart",up:"touchend",move:"touchmove"}};return i=e.document.hasOwnProperty("ontouchstart")?"mobile":"web",{restrict:"A",compile:function(){return function(t,e){var o=angular.element(r);o.css({position:"absolute",top:0,right:0,left:0,bottom:0,zIndex:1}),e.on(n[i].down,function(t){t.preventDefault();var r=e.data("resizeBar"),s=e.parent(),a=s[0].getBoundingClientRect(),h=(e[0].getBoundingClientRect(),{x:(t.touches?t.touches[0].clientX:t.clientX)-a.left,y:(t.touches?t.touches[0].clientY:t.clientY)-a.top}),l=h;o.css({display:"block"}),s.on(n[i].move,function(t){h={x:(t.touches?t.touches[0].clientX:t.clientX)-a.left,y:(t.touches?t.touches[0].clientY:t.clientY)-a.top};var e;e="x"===r.direction?100*(h.x-l.x)/a.width:100*(h.y-l.y)/a.height,r.resize(e)!==!1&&(l=h)}),s.on(n[i].up,function(){o.css({display:"none"}),s.off(n[i].move),s.off(n[i].up)})})}}}}]).factory("splitBox::utils",["$templateCache",function(t){function e(t){angular.extend(this,t),this._isHide=!1}function i(){}var r=null;return e.prototype={constructor:e,render:function(){if(!this.isRoot){var t={position:"absolute",width:"auto",left:"auto",height:"auto",top:"auto"},e=1;this.direction="x"===this.parent.direction?"y":"x";for(var i=this.prev;i&&i.isHide;)i=i.prev;this.offset=i?i.offset+i.size:0,e=this.returnScale(),this.showSize=this.isHide?0:this.size*e,this.showOffset=(this.parent.parent&&this.parent.parent.showOffset||0)+this.offset*e,this.childCount||("x"===this.direction?(t.left=this.showOffset+"%",t.top=this.parent.showOffset+"%",t.height=this.parent.showSize+"%",t.width=this.showSize+"%"):(t.left=this.parent.showOffset+"%",t.width=this.parent.showSize+"%",t.top=this.showOffset+"%",t.height=this.showSize+"%"),angular.extend(this.root.$boxs[this.domIndex].style,t))}},calcTotalShowScale:function(){for(var t=this.firstChild,e=0;t;)t.isInit||(t.isInit=!0,t._isHide=!!t.isHide,t.size=t.size||100/t.parent.childCount),t.isHide||(e+=t.size),t=t.next;this.scale=100/e},closestShowBox:function(t){for(var e=this;e&&e.isHide;)e=e[t];return e},returnScale:function(){var t=(this.parent.parent&&this.parent.parent.showSize)/100;return isNaN(t)&&(t=1),t*=this.parent.scale},hide:function(t){if(!this.isRoot&&(this.isHide=!!t,!this.isHide!=!this._isHide)){this._isHide=this.isHide;for(var e=this.nextBar;e&&e.isHide===this.isHide;)e=e.next&&e.next.nextBar;if(!e)for(e=this.prevBar;e&&e.isHide===this.isHide;)e=e.prev&&e.prev.prevBar;e&&(e.isHide=this.isHide,e.render()),this.root.config.animateClass&&this.root.rootElement.addClass(this.root.config.animateClass),this.parent.calcTotalShowScale(),isFinite(this.parent.scale)?(this.parent.hide(!1),r.render(this.parent)):this.parent.hide(!0)}},remove:function(){if(this.childCount>1){var t=this.firstChild;for(this.isDestroy=!0;t;)t.remove(),t=t.next}else if(angular.element(this.root.$boxs[this.domIndex]).remove(),this.root.$boxs[this.domIndex]=void 0,this.parent.isDestroy)return;this.parent.childCount--,this.isHide||this.parent.showChildCount--,this.prev?this.next?(this.prev.next=this.next,this.prevBar.next=this.next,this.next.prev=this.prev,this.next.prevBar=this.prevBar,r.removeResizeBar(this.nextBar)):(this.parent.lastChild=this.prev,this.prev.nextBar=this.prev.next=void 0,r.removeResizeBar(this.prevBar)):(this.parent.firstChild=this.next,this.next.prevBar=this.next.prev=void 0,r.removeResizeBar(this.nextBar)),this.parent.isDestroy||(this.parent.calcTotalShowScale(),this.parent.isRoot||r.fixStructure(this.parent),r.render(this.parent))},append:function(t){var e=this;this.childCount>1||(e=r.addParentBox(this)),r.addBox(e,t,e.childCount||2)},prepend:function(t){var e=this;this.childCount>1||(e=r.addParentBox(this)),r.addBox(e,t,0)},before:function(t){if(!this.isRoot){for(var e=0,i=this;i=i.prev;)e++;r.addBox(this.parent,t,e)}},after:function(t){if(!this.isRoot){for(var e=1,i=this;i=i.prev;)e++;r.addBox(this.parent,t,e)}}},i.prototype={constructor:i,render:function(){{var t={position:"absolute",width:"auto",left:"auto",height:"auto",top:"auto"},e=this.prev,i=this.root.config.barWidth;e.returnScale()}return this.direction=e.direction,this.isHide?void(this.root.$bars[this.domIndex].style.display="none"):(t.display="block","x"===this.direction?(t.left=e.showOffset+e.showSize+"%",t.width=i+"px",t.top=e.parent.showOffset+"%",t.height=e.parent.showSize+"%",t.marginLeft=-i/2+"px",t.cursor="col-resize"):(t.top=e.showOffset+e.showSize+"%",t.height=i+"px",t.left=e.parent.showOffset+"%",t.width=e.parent.showSize+"%",t.marginTop=-i/2+"px",t.cursor="row-resize"),void angular.extend(this.root.$bars[this.domIndex].style,t))},resize:function(t){if(!t)return!0;this.root.config.animateClass&&this.root.rootElement.removeClass(this.root.config.animateClass);var e=t/this.prev.returnScale(),i=this,n=this.root.config.minSize,o=i.prev.closestShowBox("prev"),s=i.next.closestShowBox("next");if(o.size+e>(o.minSize||n)&&s.size-e>(s.minSize||n))return o.size+=e,s.size-=e,r.render(o),r.render(s),i.render(),!0;var a="prev",h="next",l=[],d=0,p=0,x=!1;for(e>0&&(a="next",h="prev"),e=Math.abs(e);i;)i[a].isHide||(l.push(i),d+=i[a].size,p+=i[a].minSize||n),i=i[a]["prev"===a?"prevBar":"nextBar"];for(p>d-e&&(e=d-p,x=!0),i=l[0][h].closestShowBox(h),i.size=i.size+e,r.render(i);(i=l.shift())&&e;){var c=i[a].minSize||n;(i[a].size-=e)<c?(e=c-i[a].size,i[a].size=c):e=0,r.render(i[a])}return!x}},r={render:function(t){for(var e=null,i=t;e=i;)for(e.render(),e.nextBar&&e.nextBar.render(),i=e.firstChild||e.next;!i&&e&&i!==t;)i=(e=e.parent)&&e.next},transformToNextedBoxs:function(t,e){var i=[],n=new this.Box({}),o=null;n.isRoot=!0,n.root=n,n.direction=e,n.offset=n.showOffset=0,n.size=n.showSize=100;for(var s=0,a=t.length;a>s;s++)i[t[s].id]=new this.Box(t[s]);for(s=0;a>s;s++)o=i[t[s].parentId]&&t[s].id!=t[s].parentId?i[t[s].parentId]:n,o.firstChild?(o.lastChild.next=i[t[s].id],o.lastChild.next.prev=o.lastChild,o.lastChild.next.isHide||o.showChildCount++,o.childCount++):(o.firstChild=i[t[s].id],o.childCount=1,o.showChildCount=o.firstChild.isHide?0:1),o.lastChild=i[t[s].id],o.lastChild.parent=o,i[t[s].id].root=n;for(var h in i)r.fixStructure(i[h]);return n},replaceProps:function(t,e,i){var r=["parent","next","prev","prevBar","nextBar","offset","size"];angular.forEach(r,function(r,n,o){e[r]=t[r],i&&i(r,n,o)})},getItems:function(t){var e=[],r=[],n=t,o=t.firstChild;for(n.calcTotalShowScale();n=o;)for(n.childCount?n.calcTotalShowScale():(n.domIndex=e.length,e.push(n)),n.next&&(n.nextBar=new i,n.nextBar.prev=n,n.nextBar.next=n.next,n.nextBar.root=t,n.nextBar.domIndex=r.length,n.nextBar.next.prevBar=n.nextBar,r.push(n.nextBar)),o=n.firstChild||n.next;!o&&n&&o!==t;)o=(n=n.parent)&&n.next;return{boxs:e,bars:r}},fixStructure:function(t){return t.isRoot?void 0:angular.isDefined(t.childCount)&&1===t.childCount?(r.replaceProps(t,t.firstChild),!t.prev&&(t.parent.firstChild=t.firstChild),!t.next&&(t.parent.lastChild=t.firstChild),t.prev&&(t.prev.next=t.firstChild,t.prev.nextBar&&(t.prev.nextBar.next=t.firstChild)),t.next&&(t.next.prev=t.firstChild,t.next.prevBar&&(t.next.prevBar.prev=t.firstChild)),!0):void 0},removeResizeBar:function(t){angular.element(t.root.$bars[t.domIndex]).remove(),t.root.$bars[t.domIndex]=void 0},addParentBox:function(t){var i=new e({});return r.replaceProps(t,i,function(e){"size"!==e&&(t[e]=void 0)}),i.firstChild=t,i.lastChild=t,i.root=t.root,i.showChildCount=t.isHide?0:1,i.childCount=1,t.parent=i,!i.prev&&(i.parent.firstChild=i),!i.next&&(i.parent.lastChild=i),i.prev&&(i.prev.next=i,i.prev.nextBar&&(i.prev.nextBar.next=i)),i.next&&(i.next.prev=i,i.next.prevBar&&(i.next.prevBar.prev=i)),i},addBox:function(t,n,o){if(!t)return!1;n instanceof e||(n=new e(n));var s=t.root,a=new i;if(0>=o)n.next=t.firstChild,n.next.prev=n,t.firstChild=n,n.nextBar=a,n.nextBar.root=s,n.nextBar.prev=n,n.nextBar.next=n.next,n.nextBar.next.prevBar=n.nextBar;else if(o<t.childCount){for(var h=t.firstChild,l=null;--o;)h=h.next;l=h.next,n.prev=h,n.next=l,h.next=n,l.prev=n,n.prevBar=h.nextBar,h.nextBar.next=n,n.nextBar=a,n.nextBar.root=s,n.nextBar.prev=n,n.nextBar.next=n.next,n.nextBar.next.prevBar=n.nextBar}else n.prev=t.lastChild,n.prev.next=n,t.lastChild=n,n.prevBar=a,n.prevBar.root=s,n.prevBar.next=n,n.prevBar.prev=n.prev,n.prevBar.prev.nextBar=n.prevBar;a.domIndex=s.$bars.length,n.domIndex=s.$boxs.length,n.parent=t,n.root=t.root,n.isHide||t.showChildCount++,t.childCount++,t.calcTotalShowScale(),s.$boxs.push(this.boxHTML([n],s.config)[0]),s.$bars.push(this.barHTML(1,s.config)[0]),r.relateBoxs([n],s),r.relateBars([a],s),s.addDom(s.$boxs[s.$boxs.length-1],!0),s.addDom(s.$bars[s.$bars.length-1]),this.render(t)},relateBoxs:function(t,e){angular.forEach(t,function(t){angular.element(e.$boxs[t.domIndex]).data("splitBox",t)})},relateBars:function(t,e){angular.forEach(t,function(t){angular.element(e.$bars[t.domIndex]).data("resizeBar",t)})},boxHTML:function(e,i){return angular.element(e.map(function(e){return t.get(e.template)||e.template||i.boxTemplate}).join("")).attr("split-item",!0)},barHTML:function(t,e){return angular.element(new Array(t+1).join(e.barTemplate)).attr("split-bar",!0)},Box:e,ResizeBar:i}}])}(angular);